var WaveformGraph={};WaveformGraph=function(){"use strict";return WaveformGraph=function(e,a,t,i){var n,s,r,o,l,u,c,d,p,h,m,g,y,f,b,v,w,M,I,x,T,D,V,k,P,S,A,N,O;o=e,u=!1,c=!1,d=this,D="waveform",m=[],h=Math.floor(1e5*Math.random()),I=0,x=NaN,n=document.createElement("div"),n.id="waveformGraph"+h,n.style.width="100%",n.style.height="100%",r=document.createElement("div"),r.id="waveformHeader"+h,r.style.width="100%",r.style.paddingLeft="15px",r.style.paddingTop="5px",$(n).append(r),s=document.createElement("div"),s.id="waveformBody"+h,s.style.width="100%",s.style.height="85%",$(n).append(s),V=function(e,a){var t,i,o,l;i=Dygraph.defaultInteractionModel,i.contextmenu=function(e,a,t){return e.preventDefault(),!1},i.click=function(e,a,t){$(".customContextMenu").css("display","none")},o=100*(r.clientHeight+4)/n.clientHeight,s.style.height=100-o+"%",t=[],t.push([1,0]),p=new Dygraph(s,t,{colors:["#006ACB"],digitsAfterDecimal:4,legend:"never",xlabel:"Tiempo [ms]",ylabel:"Amplitud",avoidMinZero:!0,xRangePad:1,labels:e,axisLabelFontSize:10,hideOverlayOnMouseOut:!1,highlightCallback:function(e,t,i,n){i.length>0&&(l="Amplitud: "+(i[0].yval<0?"":"&nbsp;")+i[0].yval.toFixed(2)+" "+a,l+=", Tiempo: "+i[0].xval.toFixed(2)+" ms",l+=isNaN(x)?"":", "+x.toFixed(0)+" RPM",$("#"+i[0].name.replace(/\s/g,"")+h+" > span").html(l)),g=e,y=!0},unhighlightCallback:function(e){y=!1},underlayCallback:function(e,a,t){e.strokeStyle="black",e.strokeRect(a.x,a.y,a.w,a.h)},interactionModel:i,width:728,height:367}),$(".grid-stack-item").on("resizestop",function(){var e=100*(r.clientHeight+4)/n.clientHeight;s.style.height=100-e+"%",setTimeout(function(){p.resize()},200)})},k=function(e,a,t,i,n,s,r){switch(r=new Date(r).getTime().toString(),o){case 0:T=PublisherSubscriber.subscribe("/realtime/refresh",m,function(e){var r,o,l;r=e[M.Id],r&&null!==r.Value&&(i&&(o=e[i].Value),n&&(l=e[n].Value),I=clone(e[a.Id].Value),x=t?clone(e[t.Id].Value):NaN,P(r,u,enableFilter,stopFrecuency,p,s,a.Name,o,l))});break;case 1:T=PublisherSubscriber.subscribe("/historic/refresh",m,function(e){var o,l,c;o=e[M.Id][r],o&&(i&&(l=e[i][r].Value),n&&(c=e[n][r].Value),I=clone(e[a.Id][r].Value),x=t?clone(e[t.Id][r].Value):NaN,P(o,u,enableFilter,stopFrecuency,p,s,a.Name,l,c))}),(new HistoricalTimeMode).GetDataByTimeStamp(e,m,r);break;case 2:T=PublisherSubscriber.subscribe("/event/refresh",m,function(e){P(e)})}},P=function(e,a,t,i,n,s,r,o,l){if(!a){O=e;var u,c,d,p,m,v;if(f!==e.TimeStamp){d=Math.round(e.SampleRate),p=e.Value.length/e.SampleRate,u=t?GetXYDataOnTime(GetFilterSignal(e.RawValue,i),p):e.Value,f=e.TimeStamp,c=n.user_attrs_.ylabel.split(" [")[0],v=w.Name+"&nbsp;&nbsp;Ang:&nbsp;",v+=parseAng(w.SensorAngle)+"&deg;, ",v+=r+": "+I.toFixed(2)+" "+s+", &nbsp;"+f,void 0!==o&&void 0!==l&&(v+=", "+o.toFixed(2)+"&ang;+"+l.toFixed(2)+"&deg;"),$("#"+w.Name.replace(/\s/g,"")+h+" > span").html(v),n.updateOptions({file:u,ylabel:c+" ["+s.split(" ")[0]+"]"});var M=[];if(e.KeyphasorPositionsOnTime&&e.KeyphasorPositionsOnTime.length>2)for(m=0;m<e.KeyphasorPositionsOnTime.length;m+=1)M.push({series:b[0],x:e.KeyphasorPositionsOnTime[m],width:10,height:10,cssClass:"keyphasor-annotation"});n.setAnnotations(M),y?n.mouseMove_(g):DygraphOps.dispatchMouseMove(n,0,0)}}},A=function(){S=PublisherSubscriber.subscribe("/applyfilter",null,function(){O&&null!==O.Value&&N(O,enableFilter,stopFrecuency,p)})},N=function(e,a,t,i){var n,s,r,o;s=Math.round(e.SampleRate),r=e.Value.length/e.SampleRate,n=a?GetXYDataOnTime(GetFilterSignal(e.RawValue,t),r):e.Value,i.updateOptions({file:n});var l=[];if(e.KeyphasorPositionsOnTime&&e.KeyphasorPositionsOnTime.length>2)for(o=0;o<e.KeyphasorPositionsOnTime.length;o+=1)l.push({series:b[0],x:e.KeyphasorPositionsOnTime[o],width:10,height:10,cssClass:"keyphasor-annotation"});i.setAnnotations(l),y?i.mouseMove_(g):DygraphOps.dispatchMouseMove(i,0,0)},this.Show=function(e,s){var r,p,g,y,f,I,x,T,P;switch(o){case 0:if(w=selectedMeasurementPoint,v=selectedAsset,!v.AsdaqId)return void popUp("info","No hay datos tiempo real para el activo seleccionado.");break;case 1:w=ej.DataManager(mainCache.loadedMeasurementPoints).executeLocal((new ej.Query).where("Id","equal",e,!1))[0],v=new ej.DataManager(mainCache.loadedAssets).executeLocal((new ej.Query).where("AssetId","equal",w.ParentId,!1))[0]}if(r=ej.DataManager(mainCache.loadedMeasurementPoints).executeLocal((new ej.Query).where("Id","equal",w.AngularReferenceId,!1))[0],p=w.SubVariables,M=ej.DataManager(p).executeLocal((new ej.Query).where("ValueType","equal",3,!1))[0],g=ej.DataManager(p).executeLocal((new ej.Query).where("IsDefaultValue","equal",!0,!1))[0],r&&(y=ej.DataManager(r.SubVariables).executeLocal((new ej.Query).where("MeasureType","equal",9,!1))[0]),!M)return void popUp("info","No existe una subvariable configurada para forma de onda.");if(m.push(M.Id),g)switch(m.push(g.Id),P=g.Units,g.MeasureType){case 1:P+=" p";break;case 2:P+=" pp";break;case 3:P+=" rms"}y&&m.push(y.Id),f=ej.DataManager(p).executeLocal((new ej.Query).where("MeasureType","equal",4,!1))[0],f&&(m.push(f.Id),f=f.Id),I=ej.DataManager(p).executeLocal((new ej.Query).where("MeasureType","equal",6,!1))[0],I&&(m.push(I.Id),I=I.Id),b=["Amplitud"],l=new AspectrogramWidget({widgetId:h,parentId:"awContainer",content:n,title:"Forma de onda",width:a,height:t,aspectRatio:i,graphType:D,timeMode:o,asdaqId:v.AsdaqId,subVariableIdList:m,asset:v.Name,seriesName:b,measurementPointList:[w.Name.replace(/\s/g,"")],pause:0==o?!0:!1,onClose:function(){d.Close()},onPause:function(){u=!u},onMove:function(){c=!c;var e=$(".grid-stack").data("gridstack"),a=$('.grid-stack-item-content[data-id="'+h+'"]').parent();e.movable(a,c)}}),x=["Estampa de tiempo"],x.pushArray(b),T=[w.Id],r&&T.push(r.Id),k(T,g,y,f,I,P,s),A(),l.open(),V(x,P)},this.Close=function(){T&&T.remove(),S&&S.remove();var e,a;p&&p.destroy(),e=$(".grid-stack").data("gridstack"),a=$(n).parents().eq(2),e.removeWidget(a),$(n).remove(),$.each(globalsReport.elemDygraph,function(e){return globalsReport.elemDygraph[e].id===n.id?(globalsReport.elemDygraph.splice(e,1),!1):void 0}),u=!0}}}();